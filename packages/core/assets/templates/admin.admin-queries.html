<% TITLE = `${CTX.app.name} - ${$t("tymber.adminQueries.adminQueries")}`; %>

<nav class="breadcrumb" aria-label="breadcrumbs">
  <ul>
    <li><a href="/admin" aria-current="page"><%= $t("tymber.common.home") %></a></li>
    <li class="is-active"><a href="#" aria-current="page"><%= $t("tymber.adminQueries.adminQueries") %></a></li>
  </ul>
</nav>

<h1 class="title"><%= $t("tymber.adminQueries.adminQueries") %></h1>

<div id="app"></div>

<script type="module">
  import { createApp } from "vue";
  import { doFetch, Toast, DataTable, snakeToCamelCase, camelToSnakeCase, LazyInput } from "./utils";

  createApp({
    components: {
      Toast,
      DataTable,
      LazyInput,
    },

    data() {
      return {
        showSuccessToast: false,
        showInvalidQueryToast: false,
        showUnknownErrorToast: false,
        isQueryLoading: false,
        isDryRun: true,
        affectedRows: 0,
        form: {
          query: "",
          comment: "",
        },
        headers: [
          {
            text: "#",
            value: "id",
            isSortable: true,
          },
          {
            text: "<%= $t('tymber.common.createdAt') %>",
            value: "createdAt",
            isSortable: true,
          },
          {
            text: "<%= $t('tymber.common.createdBy') %>",
            value: "createdBy.username"
          },
          {
            text: "<%= $t('tymber.adminQueries.comment') %>",
            value: "comment",
          },
          {
            text: "",
            value: "actions"
          }
        ],
        isLoading: false,
        shouldRerun: false,
        searchText: "",
        value: [],
        options: {
          sortBy: "id",
          sortDesc: true,
        }
      }
    },

    methods: {
      async onSubmit() {
        this.isQueryLoading = true;

        if (this.isDryRun) {
          const res = await doFetch({
            path: "/api/admin/admin_queries/_dry_run",
            method: "POST",
            payload: this.form
          });

          if (res.ok) {
            this.affectedRows = res.body.affectedRows;
            this.isDryRun = false;
          } else {
            if (res.status === 400) {
              this.showInvalidQueryToast = true;
            } else if (res.status === 500) {
              this.showUnknownErrorToast = true;
            }
          }
        } else {
          const res = await doFetch({
            path: "/api/admin/admin_queries",
            method: "POST",
            payload: this.form
          });

          if (res.ok) {
            this.showSuccessToast = true;
            this.loadItems();
          } else {
            this.showUnknownErrorToast = true;
          }

          this.isDryRun = true;
        }

        this.isQueryLoading = false;
      },

      restoreQuery(query) {
        this.isDryRun = true;
        this.form.query = query;
      },

      readQueryParams() {
        const query = new URLSearchParams(window.location.search);
        this.searchText = query.get("q") || "";

        const sort = query.get("s");

        if (sort) {
          const parts = sort.split("|");
          const column = snakeToCamelCase(parts[0]);
          if (this.headers.some(h => h.value === column) && ["asc", "desc"].includes(parts[1])) {
            this.options.sortBy = column;
            this.options.sortDesc = parts[1] === "desc";
          }
        }
      },

      updateQueryParams() {
        const query = new URLSearchParams();

        query.set("q", this.searchText);
        query.set("s", `${camelToSnakeCase(this.options.sortBy)}|${this.options.sortDesc ? "desc" : "asc"}`);

        window.history.replaceState(null, '', `${window.location.pathname}?${query}`);
      },

      async loadItems() {
        if (this.isLoading) {
          this.shouldRerun = true;
          return;
        }
        this.isLoading = true;

        const res = await doFetch({
          path: "/api/admin/admin_queries",
          query: {
            q: this.searchText,
            sort: `${camelToSnakeCase(this.options.sortBy)}:${this.options.sortDesc ? "desc" : "asc"}`
          }
        })

        this.value = res.body.items;
        this.isLoading = false;

        if (this.shouldRerun) {
          this.shouldRerun = false;
          return this.loadItems();
        }
      },

      onOptionsUpdate(options) {
        this.options.sortBy = options.sortBy;
        this.options.sortDesc = options.sortDesc;

        this.updateQueryParams();
        this.loadItems();
      },

      onSearchUpdate(value) {
        this.searchText = value;
        this.updateQueryParams();
        this.loadItems();
      }
    },

    computed: {
      isDryRunValid() {
        return this.form.query.length > 2;
      },
      isRunValid() {
        return this.form.query.length > 2
          && this.form.comment.length > 2;
      },
      affectedRowsLabel() {
        return `<%= $t('tymber.adminQueries.affectedRows') %>`;
      }
    },

    created() {
      this.readQueryParams();
      this.loadItems();
    },

    template: `
      <Toast v-model="showSuccessToast" class="is-success">
        <%= $t("tymber.adminQueries.success") %>
      </Toast>

      <Toast v-model="showInvalidQueryToast" class="is-warning">
        <%= $t("tymber.adminQueries.invalidQuery") %>
      </Toast>

      <Toast v-model="showUnknownErrorToast" class="is-danger">
        <%= $t("tymber.common.unknownError") %>
      </Toast>

      <form @submit.prevent="onSubmit">
        <div class="columns">
          <div class="column is-8">
            <label class="label" for="query"><%= $t("tymber.adminQueries.query") %></label>
            <textarea v-model="form.query" class="textarea" id="query" :disabled="!isDryRun"></textarea>
          </div>
          <div class="column is-4">
            <label class="label" for="comment"><%= $t("tymber.adminQueries.comment") %></label>
            <textarea v-model="form.comment" class="textarea" id="comment"></textarea>
          </div>
        </div>
        <div class="field is-grouped is-grouped-right">
          <div class="control" v-if="isDryRun">
            <button class="button is-primary" type="submit" :disabled="isQueryLoading || !isDryRunValid" :class="{ 'is-loading': isQueryLoading }"><%= $t("tymber.adminQueries.dryRun") %></button>
          </div>
          <div class="field-label is-normal" v-if="!isDryRun">
            <label>{{ affectedRowsLabel }}</label>
          </div>
          <div class="control" v-if="!isDryRun">
            <button class="button" type="reset" @click="isDryRun = true" :disabled="isQueryLoading"><%= $t("tymber.common.cancel") %></button>
          </div>
          <div class="control" v-if="!isDryRun">
            <button class="button is-primary" type="submit" :disabled="isQueryLoading || !isRunValid" :class="{ 'is-loading': isQueryLoading }"><%= $t("tymber.adminQueries.run") %></button>
          </div>
        </div>
      </form>

      <h2 class="subtitle"><%= $t("tymber.adminQueries.history") %></h2>

      <div class="is-flex">
        <div class="control has-icons-left ml-auto">
          <LazyInput class="input" :model-value="searchText" @update:model-value="onSearchUpdate" autofocus></LazyInput>

          <span class="icon is-left">
            <svg width="24" height="24">
              <use xlink:href="#magnify"></use>
            </svg>
          </span>
        </div>
      </div>

      <DataTable
          :headers="headers"
          :value="value"
          :is-loading="isLoading"
          :options="options"
          @update:options="onOptionsUpdate"
      >
        <template #["item.createdAt"]="{ value }">
          {{ value ? new Date(value).toLocaleString() : "" }}
        </template>

        <template #["item.actions"]="{ item }">
          <button class="button is-pulled-right is-small" @click="restoreQuery(item.query)">
            <span class="icon is-small">
              <svg width="24" height="24">
                <use xlink:href="#restore"></use>
              </svg>
            </span>
          </button>
        </template>
      </DataTable>
    `
  }).mount("#app");
</script>
