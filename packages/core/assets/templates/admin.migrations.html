<% TITLE = `${CTX.app.name} - ${$t("tymber.migrations.migrations")}`; %>

<nav class="breadcrumb" aria-label="breadcrumbs">
  <ul>
    <li><a href="/admin" aria-current="page"><%= $t("tymber.common.home") %></a></li>
    <li class="is-active"><a href="#" aria-current="page"><%= $t("tymber.migrations.migrations") %></a></li>
  </ul>
</nav>

<h1 class="title is-spaced"><%= $t("tymber.migrations.migrations") %></h1>

<div id="app"></div>

<script type="module">
  import { createApp } from "vue";
  import { doFetch, DataTable, snakeToCamelCase, camelToSnakeCase } from "./utils";

  createApp({
    components: {
      DataTable
    },

    data() {
      return {
        headers: [
          {
            text: "<%= $t('tymber.migrations.module') %>",
            value: "module",
          },
          {
            text: "#",
            value: "id",
          },
          {
            text: "<%= $t('tymber.common.name') %>",
            value: "name",
          },
          {
            text: "<%= $t('tymber.migrations.runAt') %>",
            value: "runAt",
            isSortable: true,
          }
        ],
        isLoading: false,
        shouldRerun: false,
        value: [],
        options: {
          sortBy: "runAt",
          sortDesc: true,
        }
      }
    },

    methods: {
      readQueryParams() {
        const query = new URLSearchParams(window.location.search);
        const sort = query.get("s");

        if (sort) {
          const parts = sort.split("|");
          const column = snakeToCamelCase(parts[0]);
          if (this.headers.some(h => h.value === column) && ["asc", "desc"].includes(parts[1])) {
            this.options.sortBy = column;
            this.options.sortDesc = parts[1] === "desc";
          }
        }
      },

      updateQueryParams() {
        const query = new URLSearchParams();

        query.set("s", `${camelToSnakeCase(this.options.sortBy)}|${this.options.sortDesc ? "desc" : "asc"}`);

        window.history.replaceState(null, '', `${window.location.pathname}?${query}`);
      },

      async loadItems() {
        if (this.isLoading) {
          this.shouldRerun = true;
          return;
        }
        this.isLoading = true;

        const res = await doFetch({
          path: "/api/admin/migrations",
          query: {
            sort: `${camelToSnakeCase(this.options.sortBy)}:${this.options.sortDesc ? "desc" : "asc"}`
          }
        })

        this.value = res.body.items;
        this.isLoading = false;

        if (this.shouldRerun) {
          this.shouldRerun = false;
          return this.loadItems();
        }
      },

      onOptionsUpdate(options) {
        this.options.sortBy = options.sortBy;
        this.options.sortDesc = options.sortDesc;

        this.updateQueryParams();
        this.loadItems();
      },
    },

    created() {
      this.readQueryParams();
      this.loadItems();
    },

    template: `
      <DataTable
        :headers="headers"
        :value="value"
        :is-loading="isLoading"
        :options="options"
        @update:options="onOptionsUpdate"
      >
        <template #["item.runAt"]="{ value }">
        {{ new Date(value).toLocaleString() }}
        </template>
      </DataTable>
    `
  }).mount("#app");
</script>
