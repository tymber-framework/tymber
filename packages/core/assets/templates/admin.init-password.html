<% TITLE = `${CTX.app.name} - ${$t("tymber.initPassword.title")}`; %>

<div id="app"></div>

<script type="module">
  import { createApp } from "vue";
  import { doFetch, Toast } from "./utils";

  createApp({
    components: {
      Toast,
    },

    data() {
      return {
        isLoading: false,
        showSuccessToast: false,
        showUnknownErrorToast: false,
        form: {
          password: "",
        }
      }
    },

    methods: {
      async onSubmit() {
        this.isLoading = true;

        const res = await doFetch({
          method: "POST",
          path: "/api/admin/init_password",
          payload: this.form
        });

        if (res.ok) {
          window.location.href = "/admin?init_password=1";
        } else {
          this.showUnknownErrorToast = true;

          setTimeout(() => {
            this.isLoading = false;
          }, 200);
        }
      }
    },

    computed: {
      isValid() {
        return this.form.password.length >= 8;
      }
    },

    template: `
      <Toast v-model="showUnknownErrorToast" class="is-danger">
        <%= $t("tymber.common.unknownError") %>
      </Toast>

      <section class="section">
        <div class="container">
          <div class="columns">
            <div class="column is-half is-offset-one-quarter">
              <h1 class="title"><%= $t("tymber.initPassword.title") %></h1>

              <form @submit.prevent="onSubmit">
                <div class="field">
                  <label class="label" for="password"><%= $t("tymber.common.password") %></label>
                  <div class="control">
                    <input class="input" type="password" id="password" name="password" v-model="form.password" />
                  </div>
                </div>

                <div class="field">
                  <div class="control">
                    <button class="button is-primary is-pulled-right" type="submit" :disabled="isLoading || !isValid" :class="{ 'is-loading': isLoading }"><%= $t("tymber.init.init") %></button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </section>
    `
  }).mount("#app");
</script>
